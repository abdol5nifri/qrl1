<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🔳 توليد QR احترافي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling/lib/qr-code-styling.js"></script>
    <style>
      /* هاد الـCSS هو اللي غيخلي الـQR يبان بدقة عالية فالشاشة */
      #qr canvas {
        width: 100% !important; /* تأكد من أن الـcanvas كيعمر الـdiv ديالو كامل */
        height: 100% !important; /* تأكد من أن الـcanvas كيعمر الـdiv ديالو كامل */
        /* هاد الخاصيات كيحسّنو جودة عرض الصورة ملي كتصغر أو تكبر */
        image-rendering: crisp-edges; /* للمتصفحات الحديثة */
        image-rendering: -moz-crisp-edges; /* لمتصفح فايرفوكس */
        image-rendering: -webkit-optimize-contrast; /* لمتصفحات كروم وسفاري */
        image-rendering: optimizeSpeed; /* لمتصفحات قديمة، كتعاون باش الصورة تبان حادة */
      }
      /* ستايلات إضافية للتصميم الجديد (ممكن تعدلهم حسب الحاجة) */
      .input-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
      }
      .input-group label {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333; /* لون النص ديال الـlabel */
      }
      .input-group input,
      .input-group select {
        border: 1px solid #e2e8f0; /* لون Border */
        border-radius: 0.375rem; /* Roundness */
        padding: 0.5rem;
        font-size: 1rem;
      }
      .input-group input::file-selector-button {
        background-color: #e2e8f0;
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
      }
      .input-group input::file-selector-button:hover {
        background-color: #cbd5e1;
      }
      .button-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* المسافة بين الأزرار */
        margin-top: 1.5rem;
      }
      .button-group button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s ease-in-out;
      }
      .qr-display-area {
        display: flex;
        flex-direction: column; /* باش الـQR والنص يكونو واحد تحت واحد */
        justify-content: center;
        align-items: center;
        padding-top: 1rem;
        padding-bottom: 1rem;
        min-height: 250px; /* زدنا الطول شوية باش يكون بلاصة للنص */
        border: 2px dashed #a0aec0; /* إطار متقطع باش يبان كأنه placeholder */
        border-radius: 1rem;
        color: #a0aec0; /* لون النص داخل الـplaceholder */
        font-size: 1.2rem;
        text-align: center;
      }
      #qr {
          /* #qr في البداية كتكون مخفية أو عندها حجم صغير */
          width: 0px; 
          height: 0px;
          overflow: hidden;
          transition: width 0.3s ease, height 0.3s ease; /* باش تبان بانسيابية */
      }
      #qr.active {
          width: 200px; /* الحجم اللي باغي للـQR ملي كيبان */
          height: 200px;
          background-color: #FFFF00; /* خلفية الـQR Code نفسه */
          border-radius: 0.5rem;
          overflow: hidden;
      }
      .qr-text-below {
        margin-top: 1rem; /* مسافة بين الـQR والنص */
        font-size: 1.5rem; /* حجم الخط ديال النص */
        font-weight: bold;
        color: #333;
      }
      /* ستايلات لمربعات الألوان */
      .color-swatch {
        width: 32px; /* حجم المربع */
        height: 32px; /* حجم المربع */
        border-radius: 50%; /* باش يكون دائري */
        cursor: pointer;
        border: 2px solid #e2e8f0; /* إطار رمادي خفيف */
        transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* ظل خفيف */
      }
      .color-swatch:hover {
        border-color: #3b82f6; /* إطار أزرق عند التحويم */
        transform: scale(1.1); /* تكبير بسيط عند التحويم */
      }
      .color-swatch.selected {
        border-color: #10B981; /* إطار أخضر ملي كيكون مختار */
        box-shadow: 0 0 0 3px rgba(16,185,129,0.5); /* ظل أخضر إضافي */
        transform: scale(1.1);
      }
      /* ستايل لرسالة الـplaceholder */
      #qr-placeholder {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          min-height: 200px; /* نفس ارتفاع الـQR باش مايتبدلش الحجم بزاف */
      }
      #qr-placeholder.hidden {
          display: none;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white shadow-xl rounded-xl p-6 w-full max-w-md">
      <h1 class="text-3xl font-extrabold mb-6 text-center text-gray-800">🔳 توليد QR احترافي</h1>

      <div class="input-group">
        <label for="text">🔗 النص أو الرابط:</label>
        <input id="text" type="text" placeholder="أدخل هنا..." />
      </div>

      <div class="input-group">
        <label class="block mb-2 font-semibold">🎨 اختر اللون:</label>
        <div id="color-palette" class="flex gap-3 mb-4 flex-wrap">
          <div class="color-swatch selected" style="background-color: #000000;" data-color="#000000"></div> <div class="color-swatch" style="background-color: #0000FF;" data-color="#0000FF"></div>
          <div class="color-swatch" style="background-color: #FF0000;" data-color="#FF0000"></div>
          <div class="color-swatch" style="background-color: #008000;" data-color="#008000"></div>
          <div class="color-swatch" style="background-color: #800080;" data-color="#800080"></div>
          <div class="color-swatch" style="background-color: #FFA500;" data-color="#FFA500"></div>
        </div>
      </div>
      <div class="input-group">
        <label for="style">🔘 الشكل:</label>
        <select id="style">
          <option value="square">مربعات</option>
          <option value="dots">نقط</option>
          <option value="rounded">دائري</option>
        </select>
      </div>

      <div class="input-group">
        <label for="logo">🖼️ شعار (اختياري):</label>
        <input id="logo" type="file" accept="image/*" />
      </div>
      
      <div class="input-group">
        <label for="bottomText">📝 نص تحت الـQR (اختياري):</label>
        <input id="bottomText" type="text" placeholder="مثال: VITORHOP" />
      </div>

      <div class="qr-display-area">
        <div id="qr-placeholder">
            <span>النتيجة ستظهر هنا</span>
        </div>
        <div id="qr" class="w-[200px] h-[200px] overflow-hidden"></div>
        <div id="text-below-qr" class="qr-text-below"></div>
      </div>

      <div class="button-group">
        <button id="download" class="bg-green-500 text-white hover:bg-green-600">⬇️ تحميل QR</button>
        <button id="share" class="bg-blue-500 text-white hover:bg-blue-600">📤 مشاركة QR</button>
      </div>
    </div>

    <script>
      const qrDiv = document.getElementById("qr");
      const qrPlaceholder = document.getElementById("qr-placeholder");
      const textInput = document.getElementById("text");

      const initialText = textInput.value;
      const initialBottomText = document.getElementById("bottomText").value;
      let currentQRColor = "#000000"; // اللون الافتراضي (أول لون غيبان)

      const qrCode = new QRCodeStyling({
        width: 1000,
        height: 1000,
        type: "canvas",
        data: initialText,
        image: "",
        dotsOptions: {
          color: currentQRColor, // غيستعمل اللون الافتراضي اللي درناه
          type: "square",
        },
        backgroundOptions: {
          color: "#FFFF00", // لون أصفر للخلفية (ثابت)
        },
        imageOptions: {
          crossOrigin: "anonymous",
          margin: 20,
        },
        margin: 30, // الهامش الأبيض حول الـQR Code نفسه
        cornersSquareOptions: {
          type: 'square', 
          color: currentQRColor,
        },
        cornersDotOptions: {
          type: 'square', 
          color: currentQRColor,
        },
      });

      qrCode.append(qrDiv); // كنضيفو الـQR Code لـdiv#qr

      function updateBottomText() {
        document.getElementById("text-below-qr").innerText = document.getElementById("bottomText").value;
      }

      function updateQRCode() {
        const text = textInput.value;
        const shape = document.getElementById("style").value;

        if (text.trim() === "") { // إذا كان حقل النص فارغاً
          qrPlaceholder.classList.remove("hidden"); // كنظهرو الـplaceholder
          qrDiv.classList.remove("active"); // كنخفيو الـQR Code الحقيقي
          document.getElementById("text-below-qr").innerText = ""; // كنخفيو النص اللي تحت الـQR
        } else { // إذا كان فيه نص
          qrPlaceholder.classList.add("hidden"); // كنخفيو الـplaceholder
          qrDiv.classList.add("active"); // كنظهرو الـQR Code
          qrCode.update({
            data: text,
            dotsOptions: {
              color: currentQRColor,
              type: shape,
            },
            backgroundOptions: {
               color: "#FFFF00",
            },
            cornersSquareOptions: { 
              color: currentQRColor,
            },
            cornersDotOptions: { 
              color: currentQRColor,
            },
          });
          updateBottomText();
        }
      }

      // تحديد مربع اللون المختار حالياً
      function setActiveColorSwatch(selectedColor) {
        document.querySelectorAll('.color-swatch').forEach(swatch => {
          if (swatch.dataset.color === selectedColor) {
            swatch.classList.add('selected');
          } else {
            swatch.classList.remove('selected');
          }
        });
      }

      // إضافة المستمعين للأحداث
      textInput.addEventListener("input", updateQRCode);
      document.getElementById("style").addEventListener("change", updateQRCode);
      document.getElementById("bottomText").addEventListener("input", updateQRCode);

      // المستمعين الجدد لمربعات الألوان
      document.querySelectorAll(".color-swatch").forEach(swatch => {
        swatch.addEventListener("click", function() {
          currentQRColor = this.dataset.color;
          setActiveColorSwatch(currentQRColor);
          updateQRCode();
        });
      });

      document.getElementById("logo").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) {
            qrCode.update({ image: "" });
            // إلى حيدنا الشعار وماكاينش نص، رجع الـplaceholder
            if (textInput.value.trim() === "") {
                updateQRCode(); // باش يرجع الـplaceholder
            }
            return;
        }
        const reader = new FileReader();
        reader.onload = function (event) {
          qrCode.update({ image: event.target.result });
          // ملي كيتحمل الشعار، تأكد أن الـQR باين
          if (textInput.value.trim() !== "") {
              qrPlaceholder.classList.add("hidden");
              qrDiv.classList.add("active");
          }
        };
        reader.readAsDataURL(file);
      });

      document.getElementById("download").addEventListener("click", () => {
        const qrCanvas = document.querySelector("#qr canvas");
        const bottomTextValue = document.getElementById("bottomText").value;

        // تحديد أحجام الـQR Code
        const qrWidth = qrCanvas.width;
        const qrHeight = qrCanvas.height;

        // إعدادات النص في الأسفل
        const fontSize = 70; 
        const font = `bold ${fontSize}px Arial`;
        const textPadding = 40; 
        const bottomMarginForImage = 50; 

        // إعدادات الإطار الأبيض
        const strokeWidth = 10; // سمك الإطار الأبيض
        const frameColor = '#FFFFFF'; // لون الإطار الأبيض

        // حساب الأبعاد الكلية للـcanvas الجديد (مع الإطار)
        let totalWidth = qrWidth + (strokeWidth * 2);
        let totalHeight = qrHeight + (strokeWidth * 2);

        // إذا كان هناك نص في الأسفل، نضيف المساحة ديالو
        if (bottomTextValue.trim()) {
            totalHeight += fontSize + textPadding + bottomMarginForImage;
        }

        const combinedCanvas = document.createElement("canvas");
        const ctx = combinedCanvas.getContext("2d");

        combinedCanvas.width = totalWidth;
        combinedCanvas.height = totalHeight; 

        // 1. رسم الخلفية البيضاء للإطار
        ctx.fillStyle = frameColor; 
        ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);

        // 2. رسم الخلفية ديال الـQR Code (الصفرة) داخل الإطار
        ctx.fillStyle = '#FFFF00'; // لون الخلفية الصفراء ديال الـQR Code
        ctx.fillRect(strokeWidth, strokeWidth, qrWidth, qrHeight); // مساحة الـQR Code فقط

        // 3. رسم الـQR Code نفسه (الـcanvas ديالو) داخل الخلفية الصفراء
        ctx.drawImage(qrCanvas, strokeWidth, strokeWidth);

        // 4. رسم النص في الأسفل إذا كان موجوداً
        if (bottomTextValue.trim()) {
            // مساحة النص السفلى (خلفية بيضاء للنص)
            ctx.fillStyle = '#FFFFFF'; // لون الخلفية البيضاء للنص
            ctx.fillRect(strokeWidth, qrHeight + strokeWidth, qrWidth, fontSize + textPadding + bottomMarginForImage);

            ctx.font = font;
            ctx.fillStyle = '#000000'; // لون النص أسود
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            const textX = (qrWidth / 2) + strokeWidth;
            const textY = qrHeight + textPadding + strokeWidth;

            ctx.fillText(bottomTextValue, textX, textY);
        }

        const link = document.createElement('a');
        link.download = 'qr-code-with-frame.png';
        link.href = combinedCanvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      document.getElementById("share").addEventListener("click", async () => {
        const canvas = document.querySelector("#qr canvas");
        canvas.toBlob(async (blob) => {
          const file = new File([blob], "qr-code.png", { type: "image/png" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({ files: [file], title: "QR Code", text: "ها هو كود QR ديالك!" });
            } catch (e) {
              alert("تم إلغاء المشاركة");
            }
          } else {
            alert("المشاركة غير مدعومة على هذا الجهاز.");
          }
        });
      });

      // في البداية: تحديث الواجهة بناءً على حالة حقل النص
      updateBottomText(); // لتحديث النص في الأسفل (إن وجد)
      setActiveColorSwatch(currentQRColor); // وضع علامة على اللون الافتراضي

      // هنا يتم فحص حقل النص عند تحميل الصفحة لأول مرة
      // إذا كان فارغا، الـplaceholder هو اللي كيبان، وإلا كيتبان الـQR Code
      updateQRCode(); 
    </script>
  </body>
</html>
