<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🔳 توليد QR احترافي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling/lib/qr-code-styling.js"></script>
    <style>
      /* هاد الـCSS هو اللي غيخلي الـQR يبان بدقة عالية فالشاشة */
      #qr canvas {
        width: 100% !important; /* تأكد من أن الـcanvas كيعمر الـdiv ديالو كامل */
        height: 100% !important; /* تأكد من أن الـcanvas كيعمر الـdiv ديالو كامل */
        /* هاد الخاصيات كيحسّنو جودة عرض الصورة ملي كتصغر أو تكبر */
        image-rendering: crisp-edges; /* للمتصفحات الحديثة */
        image-rendering: -moz-crisp-edges; /* لمتصفح فايرفوكس */
        image-rendering: -webkit-optimize-contrast; /* لمتصفحات كروم وسفاري */
        image-rendering: optimizeSpeed; /* لمتصفحات قديمة، كتعاون باش الصورة تبان حادة */
      }
      /* ستايلات إضافية للتصميم الجديد (ممكن تعدلهم حسب الحاجة) */
      .input-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
      }
      .input-group label {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333; /* لون النص ديال الـlabel */
      }
      .input-group input,
      .input-group select {
        border: 1px solid #e2e8f0; /* لون Border */
        border-radius: 0.375rem; /* Roundness */
        padding: 0.5rem;
        font-size: 1rem;
      }
      .input-group input::file-selector-button {
        background-color: #e2e8f0;
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
      }
      .input-group input::file-selector-button:hover {
        background-color: #cbd5e1;
      }
      .button-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* المسافة بين الأزرار */
        margin-top: 1.5rem;
      }
      .button-group button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s ease-in-out;
      }
      .qr-display-area {
        display: flex;
        flex-direction: column; /* باش الـQR والنص يكونو واحد تحت واحد */
        justify-content: center;
        align-items: center;
        padding-top: 1rem;
        padding-bottom: 1rem;
        min-height: 250px; /* زدنا الطول شوية باش يكون بلاصة للنص */
      }
      .qr-text-below {
        margin-top: 1rem; /* مسافة بين الـQR والنص */
        font-size: 1.5rem; /* حجم الخط ديال النص */
        font-weight: bold;
        color: #333;
      }
      /* ستايلات لمربعات الألوان */
      .color-swatch {
        width: 32px; /* حجم المربع */
        height: 32px; /* حجم المربع */
        border-radius: 50%; /* باش يكون دائري */
        cursor: pointer;
        border: 2px solid #e2e8f0; /* إطار رمادي خفيف */
        transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* ظل خفيف */
      }
      .color-swatch:hover {
        border-color: #3b82f6; /* إطار أزرق عند التحويم */
        transform: scale(1.1); /* تكبير بسيط عند التحويم */
      }
      .color-swatch.selected {
        border-color: #10B981; /* إطار أخضر ملي كيكون مختار */
        box-shadow: 0 0 0 3px rgba(16,185,129,0.5); /* ظل أخضر إضافي */
        transform: scale(1.1);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white shadow-xl rounded-xl p-6 w-full max-w-md">
      <h1 class="text-3xl font-extrabold mb-6 text-center text-gray-800">🔳 توليد QR احترافي</h1>

      <div class="input-group">
        <label for="text">🔗 النص أو الرابط:</label>
        <input id="text" type="text" placeholder="أدخل هنا..." />
      </div>

      <div class="input-group">
        <label class="block mb-2 font-semibold">🎨 اختر اللون:</label>
        <div id="color-palette" class="flex gap-3 mb-4 flex-wrap">
          <div class="color-swatch" style="background-color: #000000;" data-color="#000000"></div>
          <div class="color-swatch" style="background-color: #0000FF;" data-color="#0000FF"></div>
          <div class="color-swatch" style="background-color: #FF0000;" data-color="#FF0000"></div>
          <div class="color-swatch" style="background-color: #008000;" data-color="#008000"></div>
          <div class="color-swatch" style="background-color: #800080;" data-color="#800080"></div> <div class="color-swatch" style="background-color: #FFA500;" data-color="#FFA500"></div> </div>
      </div>
      <div class="input-group">
        <label for="style">🔘 الشكل:</label>
        <select id="style">
          <option value="square">مربعات</option>
          <option value="dots">نقط</option>
          <option value="rounded">دائري</option>
        </select>
      </div>

      <div class="input-group">
        <label for="logo">🖼️ شعار (اختياري):</label>
        <input id="logo" type="file" accept="image/*" />
      </div>
      
      <div class="input-group">
        <label for="bottomText">📝 نص تحت الـQR (اختياري):</label>
        <input id="bottomText" type="text" placeholder="مثال: VITORHOP" />
      </div>

      <div class="qr-display-area">
        <div id="qr" class="w-[200px] h-[200px] overflow-hidden"></div>
        <div id="text-below-qr" class="qr-text-below"></div>
      </div>

      <div class="button-group">
        <button id="download" class="bg-green-500 text-white hover:bg-green-600">⬇️ تحميل QR</button>
        <button id="share" class="bg-blue-500 text-white hover:bg-blue-600">📤 مشاركة QR</button>
      </div>
    </div>

    <script>
      const initialText = document.getElementById("text").value;
      const initialBottomText = document.getElementById("bottomText").value;
      let currentQRColor = "#000000"; // اللون الافتراضي (أول لون غيبان)

      const qrCode = new QRCodeStyling({
        width: 1000,
        height: 1000,
        type: "canvas",
        data: initialText,
        image: "",
        dotsOptions: {
          color: currentQRColor, // غيستعمل اللون الافتراضي اللي درناه
          type: "square",
        },
        backgroundOptions: {
          color: "#FFFF00", // لون أصفر للخلفية (ثابت)
        },
        imageOptions: {
          crossOrigin: "anonymous",
          margin: 20,
        },
        margin: 30, // الهامش الأبيض حول الـQR Code نفسه
      });

      qrCode.append(document.getElementById("qr"));

      function updateBottomText() {
        document.getElementById("text-below-qr").innerText = document.getElementById("bottomText").value;
      }

      function updateQRCode() {
        const text = document.getElementById("text").value;
        const shape = document.getElementById("style").value;

        qrCode.update({
          data: text,
          dotsOptions: {
            color: currentQRColor, // غيستعمل اللون المختار حالياً
            type: shape,
          },
          backgroundOptions: {
             color: "#FFFF00", // باش تبقى ديما صفراء
          },
        });
        updateBottomText();
      }

      // تحديد مربع اللون المختار حالياً
      function setActiveColorSwatch(selectedColor) {
        document.querySelectorAll('.color-swatch').forEach(swatch => {
          if (swatch.dataset.color === selectedColor) {
            swatch.classList.add('selected');
          } else {
            swatch.classList.remove('selected');
          }
        });
      }

      // إضافة المستمعين للأحداث
      document.getElementById("text").addEventListener("input", updateQRCode);
      document.getElementById("style").addEventListener("change", updateQRCode);
      document.getElementById("bottomText").addEventListener("input", updateQRCode);

      // المستمعين الجدد لمربعات الألوان
      document.querySelectorAll(".color-swatch").forEach(swatch => {
        swatch.addEventListener("click", function() {
          currentQRColor = this.dataset.color; // خدينا اللون من data-color
          setActiveColorSwatch(currentQRColor); // وضع علامة على اللون المختار
          updateQRCode(); // تحديث الـQR Code باللون الجديد
        });
      });

      document.getElementById("logo").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) {
            qrCode.update({ image: "" });
            return;
        }
        const reader = new FileReader();
        reader.onload = function (event) {
          qrCode.update({ image: event.target.result });
        };
        reader.readAsDataURL(file);
      });

      document.getElementById("download").addEventListener("click", () => {
        const qrCanvas = document.querySelector("#qr canvas");
        const bottomTextValue = document.getElementById("bottomText").value;

        if (!bottomTextValue.trim()) {
          qrCode.download({ name: "qr-code", extension: "png" });
          return;
        }

        const combinedCanvas = document.createElement("canvas");
        const ctx = combinedCanvas.getContext("2d");

        const qrWidth = qrCanvas.width;
        const qrHeight = qrCanvas.height;

        const fontSize = 70; 
        const font = `bold ${fontSize}px Arial`;
        const textPadding = 40; 

        const bottomMarginForImage = 50; 

        combinedCanvas.width = qrWidth;
        combinedCanvas.height = qrHeight + fontSize + textPadding + bottomMarginForImage; 

        ctx.drawImage(qrCanvas, 0, 0);

        ctx.fillStyle = '#FFFFFF'; 
        ctx.fillRect(0, qrHeight, combinedCanvas.width, combinedCanvas.height - qrHeight);

        ctx.font = font;
        ctx.fillStyle = '#000000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';

        const textX = combinedCanvas.width / 2;
        const textY = qrHeight + textPadding;

        ctx.fillText(bottomTextValue, textX, textY);

        const link = document.createElement('a');
        link.download = 'qr-code-with-text.png';
        link.href = combinedCanvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      document.getElementById("share").addEventListener("click", async () => {
        const canvas = document.querySelector("#qr canvas");
        canvas.toBlob(async (blob) => {
          const file = new File([blob], "qr-code.png", { type: "image/png" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({ files: [file], title: "QR Code", text: "ها هو كود QR ديالك!" });
            } catch (e) {
              alert("تم إلغاء المشاركة");
            }
          } else {
            alert("المشاركة غير مدعومة على هذا الجهاز.");
          }
        });
      });

      // في البداية: تحديث النص وتحديد اللون الافتراضي المختار
      updateBottomText();
      setActiveColorSwatch(currentQRColor); // وضع علامة على اللون الافتراضي
      updateQRCode(); // تحديث الـQR Code باللون الافتراضي
    </script>
  </body>
</html>
